<!--components/results-table/results-table.component.html-->

<div class="table-wrap">
  <div class="table-meta">
    <div>
      <p class="eyebrow">Results</p>
      <strong>{{ total }} matches</strong> · Page {{ pageIndex + 1 }} of {{ totalPages(total, pageSize) }}
    </div>
    <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
  </div>

  <table>
    <thead>
      <tr>
        <th class="expander"></th>
        <th *ngFor="let h of headers" [class.sortable]="h.sortable" (click)="isSortableHeader(h) && onHeaderClick(h.field)">
          {{ h.label }}
          <span class="sort-indicator" *ngIf="h.sortable && currentSort?.field === h.field">
            {{ currentSort?.direction === 'asc' ? '▲' : '▼' }}
          </span>
        </th>
        <th>Peak availability</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngIf="items?.length; else emptyState">
        <ng-container *ngFor="let item of items">
          <tr>
            <td class="expander">
              <button (click)="toggleExpand(item)" aria-label="expand row">
                {{ expanded[rowKey(item)] ? 'v' : '>' }}
              </button>
            </td>
            <td>{{ item.partNumber }}</td>
            <td>{{ item.supplierSku }}</td>
            <td>{{ item.description }}</td>
            <td><span class="pill">{{ item.branch }}</span></td>
            <td class="num">{{ item.availableQty }}</td>
            <td>{{ item.uom }}</td>
            <td class="num">{{ item.leadTimeDays ?? '--' }}</td>
            <td class="date">{{ item.lastPurchaseDate ? (item.lastPurchaseDate | date:'MMM d, y, h:mm a') : '--' }}</td>
            <td class="muted small-note">Expand row to view</td>
          </tr>

          <tr class="expand-row" *ngIf="expanded[rowKey(item)]">
            <td></td>
            <td colspan="9">
              <div class="expand-content tabs">
                <div class="tab-buttons">
                  <button
                    type="button"
                    [class.active]="selectedTab[rowKey(item)] === 'lots'"
                    (click)="selectTab(item, 'lots')">
                    Lots
                  </button>
                  <button
                    type="button"
                    [class.active]="selectedTab[rowKey(item)] === 'peak'"
                    (click)="selectTab(item, 'peak')">
                    Peak Availability
                    <span class="tab-status" *ngIf="peakLoading[item.partNumber]"> · Fetching</span>
                  </button>
                </div>

                <div class="tab-body" *ngIf="selectedTab[rowKey(item)] === 'lots'; else peakTab">
                  <ng-container *ngIf="item.lots?.length; else noLots">
                    <div class="lot" *ngFor="let lot of item.lots">
                      Lot {{ lot.lotNumber }} - Qty {{ lot.qty }} - Exp {{ lot.expirationDate || 'N/A' }}
                    </div>
                  </ng-container>
                  <ng-template #noLots>
                    <p class="muted">No lot information available.</p>
                  </ng-template>
                </div>

                <ng-template #peakTab>
                  <div class="tab-body">
                    <ng-container *ngIf="peakByPart[item.partNumber]; else peakLoad">
                      <div class="peak-line"><strong>Part:</strong> {{ peakByPart[item.partNumber]?.partNumber || item.partNumber }}</div>
                      <div class="peak-line"><strong>Total available:</strong> {{ peakByPart[item.partNumber]?.totalAvailable ?? 0 }}</div>
                      <div class="peak-line"><strong>By branch:</strong></div>
                      <div class="branch" *ngFor="let b of peakByPart[item.partNumber]?.branches">
                        {{ b.branch }}: {{ b.qty }}
                      </div>
                    </ng-container>
                    <ng-template #peakLoad>
                      <p class="muted" *ngIf="peakLoading[item.partNumber]">Fetching peak availability…</p>
                      <div class="muted" *ngIf="!peakLoading[item.partNumber]">
                        Not loaded yet.
                        <button type="button" class="ghost" (click)="fetchPeakAvailability(item)">Load peak</button>
                      </div>
                    </ng-template>
                  </div>
                </ng-template>
              </div>
            </td>
          </tr>
        </ng-container>
      </ng-container>
    </tbody>
  </table>

  <ng-template #emptyState>
    <tr>
      <td colspan="10" class="empty-state">
        <p>No results found.</p>
      </td>
    </tr>
  </ng-template>

  <div class="pager" aria-label="Pagination">
    <button type="button" (click)="goTo(pageIndex - 1)" [disabled]="pageIndex <= 0">Prev</button>
    <span>Page {{ pageIndex + 1 }} / {{ totalPages(total, pageSize) }}</span>
    <button type="button" (click)="goTo(pageIndex + 1)" [disabled]="pageIndex >= totalPages(total, pageSize) - 1">
      Next
    </button>
  </div>
</div>
